# MinerU Multimodal Contrastive Learning Data Factory Configuration
# Optimized for NTU EEE Cluster with 4x A2000 GPUs

# MinerU Parser Settings
mineru:
  # Backend options: "auto", "pipeline" (CPU), "hybrid", "vlm"
  backend: "auto"
  # Device allocation for 4x A2000
  devices: ["cuda:0", "cuda:1", "cuda:2", "cuda:3"]
  # Number of parallel workers (one per GPU)
  num_workers: 4
  # Output format: markdown with images
  output_format: "md"
  # Language settings
  language: "en"  # "en", "ch", "multi"
  # Timeout per document (seconds)
  timeout: 300

# Modal Type Definitions
modal_types:
  table:
    enabled: true
    min_rows: 3
    min_cols: 2
  figure:
    enabled: true
    min_width: 100
    min_height: 100
    include_charts: true
    include_diagrams: true
  formula:
    enabled: true
    include_inline: false  # Only block equations
  infographic:
    enabled: true
  text:
    enabled: true
    min_length: 50
    max_length: 2000

# Query Generation Settings (Text-only LLM)
query_generation:
  # LLM provider: "openai", "anthropic", "local"
  provider: "openai"
  model: "gpt-4o-mini"
  # For local deployment, use vLLM or similar
  local_model_path: null
  temperature: 0.7
  max_tokens: 200
  # Queries per element
  queries_per_element: 3
  # Batch size for API calls
  batch_size: 10
  # Rate limiting (requests per minute)
  rate_limit: 60
  # Retry settings
  max_retries: 3
  retry_delay: 2

# VLM/MLLM Query Generation Settings (Multimodal - Recommended)
vlm_query_generation:
  # Enable VLM-based query generation
  enabled: true
  # Backend options: "qwen_vllm", "qwen_local", "openai", "anthropic"
  backend: "qwen_vllm"
  # Model configurations
  models:
    qwen_vllm:
      model: "Qwen/Qwen2.5-VL-7B-Instruct"
      api_base: "http://localhost:8000/v1"
      api_key: null  # vLLM doesn't require key
    qwen_local:
      model: "Qwen/Qwen2.5-VL-7B-Instruct"
      device: "cuda:0"
    openai:
      model: "gpt-4o"  # or "gpt-4-vision-preview"
      api_key: null  # Uses OPENAI_API_KEY env var
    anthropic:
      model: "claude-3-5-sonnet-20241022"
      api_key: null  # Uses ANTHROPIC_API_KEY env var
  # Generation parameters
  temperature: 0.7
  max_tokens: 1024
  # Image processing
  max_image_size: 1024  # Max dimension for resizing
  # Queries per element by modality
  queries_per_modality:
    table: 4      # Tables benefit from more queries
    figure: 4     # Figures need visual understanding
    formula: 3    # Formulas need symbolic + semantic
    infographic: 4  # Infographics are complex
    text: 2       # Text is simpler
  # Query type distribution (for balanced training)
  query_type_ratios:
    unimodal_visual: 0.3    # Pure visual queries
    unimodal_text: 0.2      # Pure text queries
    multimodal_grounded: 0.35  # Visual + text grounded
    cross_modal_reasoning: 0.15  # Cross-modal reasoning
  # Rate limiting
  rate_limit: 30
  max_retries: 3
  retry_delay: 2.0

# Negative Sampling Strategy
negative_sampling:
  # Strategy: "random", "modal_same", "modal_mixed", "semantic_hard"
  strategy: "modal_mixed"
  # Number of negatives per query
  num_negatives: 3
  # Distribution for modal_mixed strategy
  distribution:
    hard_same_modal: 0.6
    cross_modal: 0.3
    random: 0.1
  # Use embedding similarity for hard negatives
  use_embeddings: true
  embedding_model: "sentence-transformers/all-MiniLM-L6-v2"

# Data Paths
paths:
  pdf_input: "./data/raw_pdfs"
  mineru_output: "./data/mineru_output"
  dataset_output: "./data/contrastive_data"
  checkpoint_dir: "./data/checkpoints"
  log_dir: "./logs"

# PDF Download Settings
download:
  # Sources: "arxiv", "semantic_scholar", "local"
  sources:
    - "arxiv"
  # arXiv categories for scientific papers
  arxiv_categories:
    - "cs.CL"    # Computation and Language
    - "cs.CV"    # Computer Vision
    - "cs.LG"    # Machine Learning
    - "cs.AI"    # Artificial Intelligence
  # Maximum papers per category
  max_per_category: 50
  # Date range (YYYY-MM-DD)
  date_from: "2024-01-01"
  date_to: "2025-01-31"
  # Concurrent downloads
  concurrent_downloads: 5
  # Retry settings
  max_retries: 3

# Processing Constraints
constraints:
  # Target number of documents
  target_docs: 200
  # Maximum elements per document
  max_elements_per_doc: 50
  # Minimum elements to keep document
  min_elements_per_doc: 5
  # Skip documents with errors
  skip_on_error: true
  # Checkpoint interval (documents)
  checkpoint_interval: 10

# Output Format
output:
  # Format: "jsonl", "json", "parquet", "huggingface"
  format: "jsonl"
  # Train/validation split ratio
  train_ratio: 0.9
  # Include raw images in output
  include_images: true
  # Compression
  compress: false

# Logging
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: "./logs/pipeline.log"
  console: true
